<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plateforme Appels √† Projets</title>

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #0d0d0d;
  color: #fff;
  margin: 0;
  padding-bottom: 200px;
}
.container {
  display: flex;
  min-height: 100vh;
}
.sidebar {
  width: 300px;
  background: #2c003e;
  padding: 15px;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  border-right: 2px solid #8e44ad;
  gap: 10px;
  max-height: 100vh;
  position: sticky;
  top: 0;
}
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 20px;
  overflow-y: auto;
}
.top-bar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}
.top-bar input, .top-bar select, .top-bar button {
  padding: 8px 12px;
  border-radius: 6px;
  border: none;
  font-size: 14px;
}
.top-bar input {
  flex: 1;
  min-width: 200px;
  background: #1a1a1a;
  color: #fff;
}
.top-bar select {
  background: #1a1a1a;
  color: #fff;
}
.offres {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
}
.carte, .quiz-option {
  background: #1a1a1a;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
  cursor: pointer;
  font-size: 14px;
  border: 1px solid transparent;
}
.carte:hover, .quiz-option:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(142,68,173,0.7);
  border-color: #8e44ad;
}
.carte {
  cursor: default;
}
.carte h3 {
  margin: 0 0 10px 0;
  color: #9b59b6;
  font-size: 16px;
}
.carte p {
  margin: 5px 0;
  line-height: 1.4;
}
.quiz-option.selected {
  background-color: #8e44ad;
  color: #fff;
  border-color: #9b59b6;
}
button {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  background-color: #8e44ad;
  color: white;
  cursor: pointer;
  margin-top: 5px;
  font-size: 13px;
  transition: background-color 0.2s;
}
button:hover { 
  background-color: #9b59b6; 
}
button:disabled {
  background-color: #555;
  cursor: not-allowed;
  opacity: 0.6;
}
#radarChart { 
  margin-top: 15px;
  max-height: 250px;
  background: #1a1a1a;
  border-radius: 8px;
  padding: 10px;
}
#synthese {
  font-size: 12px;
  background: #1a1a1a;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
}
#synthese h4 {
  margin: 5px 0 8px 0;
  font-size: 14px;
  color: #9b59b6;
}
#synthese ul {
  margin: 5px 0;
  padding-left: 20px;
}
#synthese li {
  margin-bottom: 5px;
  line-height: 1.3;
}
.carte a {
  color: #9b59b6;
  text-decoration: none;
  display: inline-block;
  margin-top: 8px;
}
.carte a:hover {
  color: #b57dd6;
  text-decoration: underline;
}
.quiz-question {
  margin-bottom: 10px;
}
.quiz-question p {
  margin: 0 0 8px 0;
  font-size: 14px;
  line-height: 1.4;
}
.quiz-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
}
.quiz-navigation {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  justify-content: space-between;
}
.quiz-progress {
  text-align: center;
  color: #9b59b6;
  font-size: 12px;
  margin: 5px 0;
  font-weight: bold;
}
.sidebar h2 {
  margin: 0 0 15px 0;
  font-size: 18px;
  color: #9b59b6;
  text-align: center;
}

.wishlist-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #2c003e;
  border-top: 2px solid #8e44ad;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  gap: 20px;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.5);
  z-index: 1000;
  max-height: 180px;
}
.wishlist-bar h3 {
  margin: 0;
  white-space: nowrap;
  min-width: 120px;
  color: #9b59b6;
}
.wishlist-content {
  flex: 1;
  overflow-x: auto;
  overflow-y: auto;
  max-height: 140px;
}
.wishlist-items {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}
.wishlist-item {
  background: #1a1a1a;
  padding: 10px 15px;
  border-radius: 8px;
  white-space: nowrap;
  border: 1px solid #8e44ad;
  font-size: 13px;
}
.wishlist-actions {
  display: flex;
  gap: 10px;
  flex-direction: column;
}
.wishlist-actions button {
  margin: 0;
  white-space: nowrap;
  font-size: 12px;
  padding: 8px 12px;
}

.empty-state {
  text-align: center;
  color: #999;
  padding: 40px 20px;
  font-size: 14px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="container">

  <div class="sidebar">
    <h2>üéØ Diagnostic rapide</h2>
    <div id="quiz-container"></div>
    <div class="quiz-navigation">
      <button id="btnPrev" disabled>‚Üê Pr√©c√©dent</button>
      <button id="btnNext">Suivant ‚Üí</button>
    </div>
    <div class="quiz-progress" id="quizProgress"></div>
    <canvas id="radarChart" width="300" height="300" style="display:none;"></canvas>
    <div id="synthese"></div>
    <button id="btnFiltrer" style="display:none;">üîç Afficher offres correspondantes</button>
  </div>

  <div class="main">
    <div class="top-bar">
      <input type="text" id="searchInput" placeholder="üîé Rechercher par mots-cl√©s...">
      <select id="filterRegion">
        <option value="">üìç Toutes les r√©gions</option>
        <option value="Grand Est">Grand Est</option>
        <option value="Auvergne Rh√¥ne-Alpes">Auvergne Rh√¥ne-Alpes</option>
        <option value="√éle-de-France">√éle-de-France</option>
      </select>
      <select id="filterType">
        <option value="">üéØ Tous les types de besoin</option>
        <option value="Financement">Financement</option>
        <option value="Accompagnement">Accompagnement</option>
        <option value="Outils">Outils</option>
        <option value="Ressources humaines">Ressources humaines</option>
        <option value="R√©seau">R√©seau</option>
        <option value="Autre">Autre</option>
      </select>
      <button id="btnApplySearch">Appliquer filtres</button>
    </div>

    <div class="offres" id="offres"></div>
  </div>

</div>

<div class="wishlist-bar">
  <h3>üìã Ma s√©lection</h3>
  <div class="wishlist-content">
    <div class="wishlist-items" id="wishlist"></div>
  </div>
  <div class="wishlist-actions">
    <button id="btnExportPDF">üì• T√©l√©charger PDF</button>
    <button id="btnViderWishlist">üóëÔ∏è Vider</button>
  </div>
</div>

<script>
let data = { ponctuels: [], stables: [], outils: [] };
let answers = {};
let radarChart = null;
let wishlist = [];
let currentQuestionIndex = 0;

const quizQuestions = [
  {question:"O√π en √™tes-vous de votre projet aujourd'hui ?", options:["Je n'ai qu'une id√©e","Je teste d√©j√†","Je suis lanc√©","Je cherche √† grandir"], key:"stade_maturite", type:"single"},
  {question:"Quel est votre principal besoin aujourd'hui ?", options:["Financement","Accompagnement","Outils","Ressources humaines","R√©seau","Autre"], key:"type_besoin", type:"multi"},
  {question:"Quelle est la nature principale de votre projet ?", options:["ESS","Tech","Culture","√âducation","√âcologie","Inclusion","Autre"], key:"nature_projet", type:"single"},
  {question:"Sous quelle forme existe votre projet aujourd'hui ?", options:["Aucune structure","Association","Entreprise","Coop√©rative","Autre"], key:"niveau_structuration", type:"single"},
  {question:"Quand avez-vous besoin d'une solution concr√®te ?", options:["D√®s maintenant","D'ici 1 mois","D'ici 3 mois","Plus tard"], key:"echeance", type:"single"}
];

const dataExemple = {
  ponctuels: [
    {title:"Appel √† Projet Innovation Tech", cible:"Startups", description:"Financement jusqu'√† 50k‚Ç¨ pour projets technologiques innovants", region:"Grand Est", departement:"Bas-Rhin", ville:"Strasbourg", deadline:"2025-12-15", tags:["stade_maturite:Je teste d√©j√†","type_besoin:Financement"], url:"https://exemple.com"},
    {title:"Fonds Amor√ßage ESS", cible:"Structures ESS", description:"Subvention de 10k √† 30k‚Ç¨ pour projets solidaires", region:"Auvergne Rh√¥ne-Alpes", departement:"Rh√¥ne", ville:"Lyon", deadline:"2025-11-30", tags:["stade_maturite:Je n'ai qu'une id√©e","type_besoin:Financement","nature_projet:ESS"], url:"https://exemple.com"}
  ],
  stables: [
    {title:"Programme Incubation 6 mois", cible:"Associations & Startups", description:"Accompagnement complet sur 6 mois avec mentoring et ateliers", region:"√éle-de-France", departement:"Paris", ville:"Paris", deadline:"2026-01-20", tags:["stade_maturite:Je suis lanc√©","type_besoin:Accompagnement"], url:"https://exemple.com"},
    {title:"R√©seau Entrepreneurs Sociaux", cible:"Porteurs de projets ESS", description:"Mise en r√©seau mensuelle et √©v√©nements trimestriels", region:"Grand Est", tags:["type_besoin:R√©seau","nature_projet:ESS"], url:"https://exemple.com"}
  ],
  outils: [
    {title:"Bo√Æte √† Outils Business Plan", cible:"Tous", description:"Templates gratuits pour construire votre business plan", tags:["type_besoin:Outils"], url:"https://exemple.com"},
    {title:"Guide Juridique Cr√©ation", cible:"Cr√©ateurs", description:"Documentation compl√®te sur les statuts juridiques", tags:["type_besoin:Outils","niveau_structuration:Aucune structure"], url:"https://exemple.com"}
  ]
};

async function chargerData() {
  try {
    const response = await fetch("data.json");
    if (!response.ok) { 
      console.log("Fichier data.json introuvable, utilisation des donn√©es d'exemple");
      data = dataExemple; 
    } else { 
      data = await response.json(); 
    }
  } catch(e) { 
    console.log("Erreur chargement data.json:", e);
    data = dataExemple; 
  }

  afficherOffres([...data.ponctuels, ...data.stables, ...data.outils]);
  afficherQuiz();
}

function afficherOffres(offresAff) {
  const container = document.getElementById("offres");
  container.innerHTML = "";

  if (offresAff.length === 0) { 
    container.innerHTML = "<div class='empty-state'>üîç Aucune offre ne correspond √† vos crit√®res.<br>Essayez de modifier vos filtres.</div>"; 
    return; 
  }

  offresAff.forEach(o => {
    const div = document.createElement("div");
    div.className = "carte";
    
    let html = `<h3>${escapeHtml(o.title)}</h3>`;
    if(o.cible) html += `<p><strong>üéØ Cible:</strong> ${escapeHtml(o.cible)}</p>`;
    if(o.description) html += `<p>${escapeHtml(o.description)}</p>`;
    if(o.region) html += `<p><strong>üìç R√©gion:</strong> ${escapeHtml(o.region)}</p>`;
    if(o.departement) html += `<p><strong>D√©partement:</strong> ${escapeHtml(o.departement)}</p>`;
    if(o.ville) html += `<p><strong>Ville:</strong> ${escapeHtml(o.ville)}</p>`;
    if(o.deadline) html += `<p><strong>‚è∞ Date limite:</strong> ${escapeHtml(o.deadline)}</p>`;
    if(o.url) html += `<a href="${escapeHtml(o.url)}" target="_blank" rel="noopener noreferrer">üîó En savoir plus</a>`;
    
    div.innerHTML = html;
    
    const btn = document.createElement("button");
    btn.textContent = "‚ûï Ajouter √† ma s√©lection";
    btn.onclick = () => ajouterWishlist(o.title);
    div.appendChild(btn);
    
    container.appendChild(div);
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function afficherQuiz() {
  afficherQuestion(currentQuestionIndex);
  updateQuizProgress();
}

function afficherQuestion(index) {
  const container = document.getElementById("quiz-container");
  container.innerHTML = "";

  if(index >= quizQuestions.length){
    genererSynthese();
    document.getElementById("radarChart").style.display = "block";
    document.getElementById("btnFiltrer").style.display = "block";
    document.getElementById("btnNext").style.display = "none";
    document.getElementById("btnPrev").style.display = "none";
    document.getElementById("quizProgress").innerHTML = "<strong>‚úÖ Quiz termin√© !</strong>";
    return;
  }

  const q = quizQuestions[index];
  const qDiv = document.createElement("div");
  qDiv.className = "quiz-question";
  
  const questionText = document.createElement("p");
  questionText.innerHTML = `<strong>${escapeHtml(q.question)}</strong>`;
  qDiv.appendChild(questionText);
  
  if(q.type === "multi") {
    const hint = document.createElement("small");
    hint.style.color = "#9b59b6";
    hint.textContent = "(Plusieurs r√©ponses possibles)";
    qDiv.appendChild(hint);
  }
  
  const optionsDiv = document.createElement("div");
  optionsDiv.className = "quiz-options";

  q.options.forEach(opt => {
    const optDiv = document.createElement("div");
    optDiv.className = "quiz-option";
    optDiv.textContent = opt;
    optDiv.dataset.value = opt;

    if(answers[q.key] && answers[q.key].includes(opt)) {
      optDiv.classList.add("selected");
    }

    optDiv.onclick = () => {
      if(q.type === "single") {
        answers[q.key] = [opt];
        Array.from(optionsDiv.children).forEach(c => c.classList.remove("selected"));
        optDiv.classList.add("selected");
      } else {
        answers[q.key] = answers[q.key] || [];
        if(answers[q.key].includes(opt)) {
          answers[q.key] = answers[q.key].filter(x => x !== opt);
          optDiv.classList.remove("selected");
        } else {
          answers[q.key].push(opt);
          optDiv.classList.add("selected");
        }
      }
    };
    optionsDiv.appendChild(optDiv);
  });
  
  qDiv.appendChild(optionsDiv);
  container.appendChild(qDiv);
  
  document.getElementById("btnPrev").disabled = (index === 0);
  document.getElementById("btnNext").textContent = (index === quizQuestions.length - 1) ? "‚úì Terminer" : "Suivant ‚Üí";
}

function updateQuizProgress() {
  document.getElementById("quizProgress").innerHTML = `Question ${currentQuestionIndex + 1} / ${quizQuestions.length}`;
}

document.getElementById("btnNext").addEventListener("click", () => {
  currentQuestionIndex++;
  afficherQuestion(currentQuestionIndex);
  updateQuizProgress();
});

document.getElementById("btnPrev").addEventListener("click", () => {
  currentQuestionIndex--;
  afficherQuestion(currentQuestionIndex);
  updateQuizProgress();
});

function genererSynthese() {
  let texte = "<h4>Synth√®se de votre profil :</h4><ul>";
  for(let k in answers) {
    if(answers[k] && answers[k].length > 0) {
      const label = k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      texte += `<li><strong>${escapeHtml(label)}:</strong> ${answers[k].map(v => escapeHtml(v)).join(", ")}</li>`;
    }
  }
  texte += "</ul>";
  document.getElementById("synthese").innerHTML = texte;
  afficherRadar();
}

function afficherRadar() {
  const axes = ["stade_maturite", "type_besoin", "nature_projet", "niveau_structuration", "echeance"];
  const labels = axes.map(a => a.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
  const valeurs = axes.map(a => answers[a] ? answers[a].length * 2 : 0);
  
  const ctx = document.getElementById('radarChart').getContext('2d');
  const dataRadar = {
    labels: labels,
    datasets: [{
      label: "Diagnostic projet",
      data: valeurs,
      fill: true,
      backgroundColor: "rgba(142,68,173,0.3)",
      borderColor: "rgba(142,68,173,1)",
      pointBackgroundColor: "rgba(142,68,173,1)",
      pointBorderColor: "#fff",
      pointHoverBackgroundColor: "#fff",
      pointHoverBorderColor: "rgba(142,68,173,1)"
    }]
  };
  
  if(radarChart) radarChart.destroy();
  
  radarChart = new Chart(ctx, {
    type: 'radar',
    data: dataRadar,
    options: {
      scales: {
        r: {
          beginAtZero: true,
          ticks: { color: '#9b59b6' },
          grid: { color: '#444' },
          pointLabels: { color: '#fff', font: { size: 10 } }
        }
      },
      plugins: {
        legend: { labels: { color: '#fff' } }
      }
    }
  });
}

function filtrerOffres() {
  const all = [...data.ponctuels, ...data.stables, ...data.outils];
  const filtres = [];
  
  for(let k in answers) {
    if(answers[k]) {
      answers[k].forEach(v => filtres.push(`${k}:${v}`));
    }
  }
  
  if(filtres.length === 0) return all;
  
  return all.filter(o => {
    if(!o.tags) return false;
    return o.tags.some(t => filtres.includes(t));
  });
}

document.getElementById("btnFiltrer").addEventListener("click", () => {
  afficherOffres(filtrerOffres());
});

function ajouterWishlist(title) {
  const all = [...data.ponctuels, ...data.stables, ...data.outils];
  const o = all.find(x => x.title === title);
  
  if(o && !wishlist.find(w => w.title === title)) {
    wishlist.push(o);
    afficherWishlist();
  }
}

function afficherWishlist() {
  const container = document.getElementById("wishlist");
  container.innerHTML = "";
  
  if(wishlist.length === 0) {
    container.innerHTML = "<p style='color:#999; margin:0;'>Aucune offre s√©lectionn√©e</p>";
    return;
  }
  
  wishlist.forEach(o => {
    const div = document.createElement("div");
    div.className = "wishlist-item";
    div.innerHTML = `<strong>${escapeHtml(o.title)}</strong>${o.deadline ? ` - ${escapeHtml(o.deadline)}` : ""}`;
    container.appendChild(div);
  });
}

function viderWishlist() {
  if(wishlist.length === 0) return;
  if(confirm("Voulez-vous vraiment vider votre s√©lection ?")) {
    wishlist = [];
    afficherWishlist();
  }
}

function exportPDF() {
  if(wishlist.length === 0) {
    alert("Votre s√©lection est vide.");
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;
  
  doc.setFontSize(18);
  doc.text("Ma s√©lection d'offres", 10, y);
  y += 15;
  
  doc.setFontSize(10);
  doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 10, y);
  y += 15;
  
  wishlist.forEach((o, index) => {
    if(y > 270) {
      doc.addPage();
      y = 20;
    }
    
    doc.setFontSize(14);
    doc.text(`${index + 1}. ${o.title}`, 10, y);
    y += 7;
    
    doc.setFontSize(10);
    if(o.deadline) {
      doc.text(`   Date limite: ${o.deadline}`, 10, y);
      y += 6;
    }
    if(o.cible) {
      doc.text(`   Cible: ${o.cible}`, 10, y);
      y += 6;
    }
    if(o.region) {
      doc.text(`   R√©gion: ${o.region}`, 10, y);
      y += 6;
    }
    if(o.url) {
      doc.setTextColor(100, 100, 200);
      doc.text(`   ${o.url}`, 10, y);
      doc.setTextColor(0, 0, 0);
      y += 6;
    }
    y += 5;
  });
  
  doc.save("ma-selection-appels-projets.pdf");
}

document.getElementById("btnExportPDF").addEventListener("click", exportPDF);
document.getElementById("btnViderWishlist").addEventListener("click", viderWishlist);

document.getElementById("btnApplySearch").addEventListener("click", () => {
  const searchTerm = document.getElementById("searchInput").value.toLowerCase().trim();
  const region = document.getElementById("filterRegion").value;
  const type = document.getElementById("filterType").value;
  
  const all = [...data.ponctuels, ...data.stables, ...data.outils];
  
  const filtered = all.filter(o => {
    let textMatch = true;
    if(searchTerm) {
      textMatch = o.title.toLowerCase().includes(searchTerm) ||
                  (o.description && o.description.toLowerCase().includes(searchTerm)) ||
                  (o.cible && o.cible.toLowerCase().includes(searchTerm));
    }
    
    let regionMatch = !region || (o.region && o.region === region);
    let typeMatch = !type || (o.tags && o.tags.some(t => t.includes(`type_besoin:${type}`)));
    
    return textMatch && regionMatch && typeMatch;
  });
  
  afficherOffres(filtered);
});

document.getElementById("searchInput").addEventListener("keypress", (e) => {
  if(e.key === "Enter") {
    document.getElementById("btnApplySearch").click();
  }
});

window.onload = () => {
  chargerData();
  afficherWishlist();
};
</script>

</body>
</html>
