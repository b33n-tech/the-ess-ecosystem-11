<script>
// --- INITIALISATION ---
let quizQuestions = [
  {
    question: "O√π en √™tes-vous de votre projet aujourd'hui ?",
    options: ["Je n'ai qu'une id√©e", "Je teste d√©j√†", "Je suis lanc√©"]
  },
  {
    question: "Quel type de besoin avez-vous ?",
    options: ["Financement", "Accompagnement", "Outils"]
  },
  {
    question: "Quel est le secteur de votre projet ?",
    options: ["ESS", "Tech", "Autre"]
  }
];

let currentStep = 0;
let userAnswers = [];
let offresData = [];

// --- CHARGEMENT DU JSON ---
async function loadData() {
  try {
    const response = await fetch('data.json');
    const data = await response.json();
    offresData = [...data.ponctuels, ...data.stables, ...data.outils];
    renderOffres(offresData); // affichage initial de toutes les offres
  } catch (err) {
    console.error("Erreur chargement data.json :", err);
  }
}

// --- QUIZ ---
function renderQuizStep() {
  const questionObj = quizQuestions[currentStep];
  document.getElementById('questionText').textContent = questionObj.question;
  const quizOptions = document.getElementById('quizOptions');
  quizOptions.innerHTML = questionObj.options.map(opt => `
    <div class="quiz-option">${opt}</div>
  `).join('');

  // Ajout des listeners sur les options
  document.querySelectorAll('.quiz-option').forEach((el, idx) => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      userAnswers[currentStep] = opt = questionObj.options[idx];
    });
  });

  // Boutons
  document.getElementById('btnPrev').disabled = currentStep === 0;
  document.getElementById('btnNext').textContent = currentStep === quizQuestions.length - 1 ? 'Terminer ‚úÖ' : 'Suivant ‚Üí';
}

document.getElementById('btnNext').addEventListener('click', () => {
  if (!userAnswers[currentStep]) return alert("Veuillez s√©lectionner une option !");
  if (currentStep < quizQuestions.length - 1) {
    currentStep++;
    renderQuizStep();
  } else {
    // FIN DU QUIZ
    document.querySelector('.quiz-container').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'block';
    filterOffresByQuiz();
  }
});

document.getElementById('btnPrev').addEventListener('click', () => {
  if (currentStep > 0) {
    currentStep--;
    renderQuizStep();
  }
});

document.getElementById('btnShowMatches').addEventListener('click', () => {
  document.querySelector('.main-content').scrollIntoView({ behavior: 'smooth' });
});

// --- OFFRES ---
function renderOffres(offres) {
  const container = document.getElementById('offresContainer');
  if (offres.length === 0) {
    container.innerHTML = `<div class="empty-state"><h3>Aucune offre trouv√©e</h3><p>Essayez de modifier vos crit√®res ou revenir plus tard.</p></div>`;
    return;
  }
  container.innerHTML = offres.map(o => `
    <div class="offre-card">
      <h3>${o.title}</h3>
      <div class="offre-meta">
        ${o.tags.map(t => `<span class="meta-tag">${t.split(':')[1]}</span>`).join('')}
        ${o.region ? `<span class="meta-tag">üìç ${o.region}</span>` : ''}
      </div>
      <p class="offre-description">${o.description}</p>
      <div class="offre-actions">
        <a href="${o.url}" target="_blank" style="color: var(--primary); text-decoration: none; font-size: 14px;">En savoir plus ‚Üí</a>
        <button class="btn-icon">‚ù§Ô∏è Ajouter</button>
      </div>
    </div>
  `).join('');

  // Wishlist boutons
  document.querySelectorAll('.btn-icon').forEach((btn, idx) => {
    btn.addEventListener('click', () => {
      updateWishlistCount(parseInt(document.getElementById('wishlistCount').textContent) + 1);
    });
  });
}

// --- FILTRAGE SELON QUIZ ---
function filterOffresByQuiz() {
  let filtered = offresData.filter(offre => {
    return userAnswers.every(answer => 
      offre.tags.some(tag => tag.includes(answer))
    );
  });
  renderOffres(filtered);
}

// --- WISHLIST ---
function updateWishlistCount(count) {
  document.getElementById('wishlistCount').textContent = count;
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  renderQuizStep();
  updateWishlistCount(0);
});
</script>
