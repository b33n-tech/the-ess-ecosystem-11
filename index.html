<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plateforme Appels √† Projets V4.3</title>

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #0d0d0d;
  color: #fff;
  margin: 0;
  padding-bottom: 200px;
}
.container {
  display: flex;
  height: calc(100vh - 200px);
}
.sidebar {
  width: 300px;
  background: #2c003e;
  padding: 15px;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  border-right: 2px solid #8e44ad;
  gap: 10px;
}
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 20px;
  overflow-y: auto;
}
.top-bar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}
.top-bar input, .top-bar select, .top-bar button {
  padding: 5px 10px;
  border-radius: 6px;
  border: none;
}
.offres {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}
.carte, .quiz-option {
  background: #1a1a1a;
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
  cursor: pointer;
  font-size: 14px;
}
.carte:hover, .quiz-option:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(142,68,173,0.7);
}
.quiz-option.selected {
  background-color: #8e44ad;
  color: #fff;
}
button {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  background-color: #8e44ad;
  color: white;
  cursor: pointer;
  margin-top: 5px;
  font-size: 13px;
}
button:hover { background-color: #9b59b6; }
button:disabled {
  background-color: #555;
  cursor: not-allowed;
}
#radarChart { 
  margin-top: 10px;
  max-height: 200px;
}
#synthese {
  font-size: 12px;
}
#synthese h4 {
  margin: 10px 0 5px 0;
  font-size: 14px;
}
#synthese ul {
  margin: 5px 0;
  padding-left: 20px;
}
#synthese li {
  margin-bottom: 3px;
}
.carte a {
  color: #9b59b6;
  text-decoration: none;
}
.carte a:hover {
  color: #8e44ad;
}
.quiz-question {
  margin-bottom: 10px;
}
.quiz-options {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 6px;
}
.quiz-navigation {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  justify-content: space-between;
}
.quiz-progress {
  text-align: center;
  color: #9b59b6;
  font-size: 12px;
  margin: 5px 0;
}
.sidebar h2 {
  margin: 0 0 10px 0;
  font-size: 18px;
}

/* Barre de s√©lection en bas */
.wishlist-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #2c003e;
  border-top: 2px solid #8e44ad;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  gap: 20px;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.5);
  z-index: 1000;
  max-height: 180px;
  overflow: hidden;
}
.wishlist-bar h3 {
  margin: 0;
  white-space: nowrap;
  min-width: 120px;
}
.wishlist-content {
  flex: 1;
  overflow-x: auto;
  overflow-y: auto;
  max-height: 140px;
}
.wishlist-items {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}
.wishlist-item {
  background: #1a1a1a;
  padding: 10px 15px;
  border-radius: 8px;
  white-space: nowrap;
  border: 1px solid #8e44ad;
}
.wishlist-actions {
  display: flex;
  gap: 10px;
  flex-direction: column;
}
.wishlist-actions button {
  margin: 0;
  white-space: nowrap;
  font-size: 12px;
  padding: 8px 12px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="container">

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Diagnostic rapide</h2>
    <div id="quiz-container"></div>
    <div class="quiz-navigation">
      <button id="btnPrev" disabled>Pr√©c√©dent</button>
      <button id="btnNext">Suivant</button>
    </div>
    <div class="quiz-progress" id="quizProgress"></div>
    <canvas id="radarChart" width="300" height="300" style="display:none;"></canvas>
    <div id="synthese"></div>
    <button id="btnFiltrer" style="display:none;">Afficher offres correspondant √† mon profil</button>
  </div>

  <!-- Main content -->
  <div class="main">
    <div class="top-bar">
      <input type="text" id="searchInput" placeholder="Rechercher par mots-cl√©s...">
      <select id="filterRegion">
        <option value="">Toutes les r√©gions</option>
        <option value="Grand Est">Grand Est</option>
        <option value="Auvergne Rh√¥ne-Alpes">Auvergne Rh√¥ne-Alpes</option>
        <option value="√éle-de-France">√éle-de-France</option>
      </select>
      <select id="filterType">
        <option value="">Tous les types de besoin</option>
        <option value="Financement">Financement</option>
        <option value="Accompagnement">Accompagnement</option>
        <option value="Outils">Outils</option>
        <option value="Ressources humaines">Ressources humaines</option>
        <option value="R√©seau">R√©seau</option>
        <option value="Autre">Autre</option>
      </select>
      <button id="btnApplySearch">Appliquer filtres</button>
    </div>

    <div class="offres" id="offres"></div>
  </div>

</div>

<!-- Barre de s√©lection en bas -->
<div class="wishlist-bar">
  <h3>Ma s√©lection</h3>
  <div class="wishlist-content">
    <div class="wishlist-items" id="wishlist"></div>
  </div>
  <div class="wishlist-actions">
    <button id="btnExportPDF">üì• T√©l√©charger PDF</button>
    <button id="btnViderWishlist">üóëÔ∏è Vider</button>
  </div>
</div>

<script>
let data = { ponctuels: [], stables: [], outils: [] };
let answers = {};
let radarChart = null;
let wishlist = [];
let currentQuestionIndex = 0;

const quizQuestions = [
  {question:"O√π en √™tes-vous de votre projet aujourd'hui ?", options:["Je n'ai qu'une id√©e","Je teste d√©j√†","Je suis lanc√©","Je cherche √† grandir"], key:"stade_maturite", type:"single"},
  {question:"Quel est votre principal besoin aujourd'hui ?", options:["Financement","Accompagnement","Outils","Ressources humaines","R√©seau","Autre"], key:"type_besoin", type:"multi"},
  {question:"Quelle est la nature principale de votre projet ?", options:["ESS","Tech","Culture","√âducation","√âcologie","Inclusion","Autre"], key:"nature_projet", type:"single"},
  {question:"Sous quelle forme existe votre projet aujourd'hui ?", options:["Aucune structure","Association","Entreprise","Coop√©rative","Autre"], key:"niveau_structuration", type:"single"},
  {question:"Quand avez-vous besoin d'une solution concr√®te ?", options:["D√®s maintenant","D'ici 1 mois","D'ici 3 mois","Plus tard"], key:"echeance", type:"single"},
  {question:"Quel est votre objectif principal pour les 6 prochains mois ?", options:["Tester une id√©e","Trouver un financement","Structurer l'√©quipe","Lancer le projet","D√©velopper l'activit√©"], key:"objectif", type:"single"},
  {question:"Votre projet est-il d√©j√† financ√© ou soutenu ?", options:["Oui","Non"], key:"deja_finance", type:"single"},
  {question:"O√π est bas√© votre projet ?", options:["National","R√©gional","Local","International"], key:"territoire", type:"single"}
];

// Donn√©es d'exemple
const dataExemple = {
  ponctuels: [
    {
      title: "Appel √† projets Innovation Sociale",
      deadline: "31/12/2025",
      description: "Financement pour projets d'innovation sociale",
      region: "Grand Est",
      tags: ["type_besoin:Financement", "nature_projet:ESS", "stade_maturite:Je suis lanc√©"],
      url: "https://example.com"
    }
  ],
  stables: [
    {
      title: "Programme d'accompagnement startup",
      description: "Accompagnement personnalis√© pour entrepreneurs",
      region: "√éle-de-France",
      tags: ["type_besoin:Accompagnement", "nature_projet:Tech", "stade_maturite:Je teste d√©j√†"],
      url: "https://example.com"
    }
  ],
  outils: [
    {
      title: "Plateforme de gestion de projet",
      description: "Outil gratuit de gestion collaborative",
      tags: ["type_besoin:Outils", "stade_maturite:Je n'ai qu'une id√©e"],
      url: "https://example.com"
    }
  ]
};

async function chargerData() {
  try {
    const response = await fetch("data.json");
    if (!response.ok) {
      console.warn("Fichier data.json introuvable, utilisation des donn√©es d'exemple");
      data = dataExemple;
    } else {
      data = await response.json();
    }
  } catch (error) {
    console.warn("Erreur de chargement, utilisation des donn√©es d'exemple:", error);
    data = dataExemple;
  }
  
  afficherOffres([...data.ponctuels, ...data.stables, ...data.outils]);
  afficherQuiz();
}

function afficherOffres(offresAff) {
  const container = document.getElementById("offres");
  container.innerHTML = "";
  
  if (offresAff.length === 0) {
    container.innerHTML = "<p>Aucune offre ne correspond √† vos crit√®res.</p>";
    return;
  }
  
  offresAff.forEach(o => {
    const div = document.createElement("div");
    div.className = "carte";
    div.innerHTML = `
      <h3>${o.title}</h3>
      ${o.deadline ? `<p><strong>Deadline:</strong> ${o.deadline}</p>` : ""}
      ${o.description ? `<p>${o.description}</p>` : ""}
      ${o.region ? `<p><strong>R√©gion:</strong> ${o.region}</p>` : ""}
      ${o.tags ? `<p><strong>Tags:</strong> ${o.tags.join(", ")}</p>` : ""}
      ${o.url ? `<a href="${o.url}" target="_blank" rel="noopener">Voir plus</a>` : ""}
      <button onclick="ajouterWishlist('${o.title.replace(/'/g, "\\'")}')">Ajouter √† ma s√©lection</button>
    `;
    container.appendChild(div);
  });
}

function afficherQuiz() {
  afficherQuestion(currentQuestionIndex);
  updateQuizProgress();
}

function afficherQuestion(index) {
  const container = document.getElementById("quiz-container");
  container.innerHTML = "";
  
  if (index >= quizQuestions.length) {
    // Fin du quiz
    genererSynthese();
    document.getElementById("radarChart").style.display = "block";
    document.getElementById("btnFiltrer").style.display = "block";
    document.getElementById("btnNext").style.display = "none";
    document.getElementById("btnPrev").style.display = "none";
    document.getElementById("quizProgress").innerHTML = "<strong>‚úÖ Quiz termin√© !</strong>";
    return;
  }
  
  const q = quizQuestions[index];
  const qDiv = document.createElement("div");
  qDiv.className = "quiz-question";
  const html = `<p style="margin: 0 0 8px 0; font-size: 14px;"><strong>${q.question}</strong></p>
                ${q.type === "multi" ? "<small style='color:#9b59b6;'>(Plusieurs r√©ponses possibles)</small>" : ""}
                <div class="quiz-options"></div>`;
  qDiv.innerHTML = html;
  const optionsDiv = qDiv.querySelector(".quiz-options");
  
  q.options.forEach(opt => {
    const optDiv = document.createElement("div");
    optDiv.className = "quiz-option";
    optDiv.innerText = opt;
    optDiv.dataset.value = opt;
    
    // Restaurer la s√©lection si elle existe
    if (answers[q.key] && answers[q.key].includes(opt)) {
      optDiv.classList.add("selected");
    }
    
    optDiv.onclick = () => {
      if (q.type === "single") {
        answers[q.key] = [opt];
        Array.from(optionsDiv.children).forEach(c => c.classList.remove("selected"));
        optDiv.classList.add("selected");
      } else {
        answers[q.key] = answers[q.key] || [];
        if (answers[q.key].includes(opt)) {
          answers[q.key] = answers[q.key].filter(x => x !== opt);
          optDiv.classList.remove("selected");
        } else {
          answers[q.key].push(opt);
          optDiv.classList.add("selected");
        }
      }
    };
    optionsDiv.appendChild(optDiv);
  });
  container.appendChild(qDiv);
  
  // G√©rer les boutons de navigation
  document.getElementById("btnPrev").disabled = (index === 0);
  document.getElementById("btnNext").innerText = (index === quizQuestions.length - 1) ? "Terminer" : "Suivant";
}

function updateQuizProgress() {
  const progress = document.getElementById("quizProgress");
  progress.innerHTML = `Question ${currentQuestionIndex + 1} / ${quizQuestions.length}`;
}

document.getElementById("btnNext").addEventListener("click", () => {
  currentQuestionIndex++;
  afficherQuestion(currentQuestionIndex);
  updateQuizProgress();
});

document.getElementById("btnPrev").addEventListener("click", () => {
  currentQuestionIndex--;
  afficherQuestion(currentQuestionIndex);
  updateQuizProgress();
});

function genererSynthese() {
  let texte = "<h4>Synth√®se rapide :</h4><ul>";
  for (let k in answers) {
    if (answers[k] && answers[k].length > 0) {
      const key = k.replace(/_/g, ' ');
      texte += `<li><strong>${key}:</strong> ${answers[k].join(", ")}</li>`;
    }
  }
  texte += "</ul>";
  document.getElementById("synthese").innerHTML = texte;
  afficherRadar();
}

function afficherRadar() {
  const axes = ["stade_maturite", "type_besoin", "nature_projet", "niveau_structuration", "echeance"];
  const valeurs = axes.map(a => answers[a] ? answers[a].length * 2 : 0);
  const ctx = document.getElementById('radarChart').getContext('2d');
  const dataRadar = {
    labels: axes,
    datasets: [{
      label: "Diagnostic projet",
      data: valeurs,
      fill: true,
      backgroundColor: "rgba(142,68,173,0.2)",
      borderColor: "rgba(142,68,173,1)",
      pointBackgroundColor: "rgba(142,68,173,1)"
    }]
  };
  
  if (radarChart) radarChart.destroy();
  radarChart = new Chart(ctx, { type: 'radar', data: dataRadar });
}

function filtrerOffres() {
  const all = [...data.ponctuels, ...data.stables, ...data.outils];
  const filtres = [];
  for (let k in answers) {
    if (answers[k]) {
      answers[k].forEach(v => filtres.push(`${k}:${v}`));
    }
  }
  
  if (filtres.length === 0) {
    return all;
  }
  
  return all.filter(o => o.tags && o.tags.some(t => filtres.includes(t)));
}

document.getElementById("btnFiltrer").addEventListener("click", () => {
  const filtres = filtrerOffres();
  afficherOffres(filtres);
});

function ajouterWishlist(title) {
  const all = [...data.ponctuels, ...data.stables, ...data.outils];
  const o = all.find(x => x.title === title);
  if (o && !wishlist.find(w => w.title === title)) {
    wishlist.push(o);
    afficherWishlist();
  }
}

function afficherWishlist() {
  const container = document.getElementById("wishlist");
  container.innerHTML = "";
  
  if (wishlist.length === 0) {
    container.innerHTML = "<p style='color:#999;'>Aucune offre s√©lectionn√©e</p>";
    return;
  }
  
  wishlist.forEach(o => {
    const div = document.createElement("div");
    div.className = "wishlist-item";
    div.innerHTML = `<strong>${o.title}</strong>${o.deadline ? ` - ${o.deadline}` : ""}`;
    container.appendChild(div);
  });
}

function viderWishlist() { 
  wishlist = []; 
  afficherWishlist(); 
}

function exportPDF() {
  if (wishlist.length === 0) {
    alert("Votre s√©lection est vide. Ajoutez des offres avant d'exporter.");
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;
  doc.setFontSize(14);
  doc.text("Ma s√©lection d'offres", 10, y);
  y += 10;
  
  wishlist.forEach(o => {
    doc.setFontSize(12);
    const text = `- ${o.title}${o.deadline ? ` (${o.deadline})` : ''}`;
    doc.text(text, 10, y);
    y += 7;
    if (o.url) {
      doc.setFontSize(10);
      doc.text(`  ${o.url}`, 10, y);
      y += 7;
    }
  });
  
  doc.save("wishlist.pdf");
}

document.getElementById("btnExportPDF").addEventListener("click", exportPDF);
document.getElementById("btnViderWishlist").addEventListener("click", viderWishlist);

// Recherche + filtres dropdown
document.getElementById("btnApplySearch").addEventListener("click", () => {
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const region = document.getElementById("filterRegion").value;
  const type = document.getElementById("filterType").value;
  const all = [...data.ponctuels, ...data.stables, ...data.outils];
  
  const filtered = all.filter(o => {
    let textMatch = o.title.toLowerCase().includes(searchTerm) || 
                    (o.description && o.description.toLowerCase().includes(searchTerm));
    let regionMatch = !region || (o.region && o.region === region);
    let typeMatch = !type || (o.tags && o.tags.some(t => t.includes(`type_besoin:${type}`)));
    return textMatch && regionMatch && typeMatch;
  });
  
  afficherOffres(filtered);
});

window.onload = () => { 
  chargerData(); 
};
</script>
</body>
</html>
